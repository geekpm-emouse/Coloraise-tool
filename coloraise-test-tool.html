<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coloraise 颜色测试</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --highlight-bg: #fff3cd;
            --highlight-border: #ffc107;
            --difference-bg: #f8d7da;
            --difference-border: #dc3545;
            --formula-bg: #f0f0f0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a;
                --card-bg: #2d2d2d;
                --text-color: #e0e0e0;
                --border-color: #555;
                --shadow: 0 2px 4px rgba(0,0,0,0.3);
                --highlight-bg: #3d3d00;
                --highlight-border: #ffcc00;
                --difference-bg: #4d1f1f;
                --difference-border: #ff4444;
                --formula-bg: #3a3a3a;
            }
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .comparison-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .mixing-method {
            flex: 1;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease;
        }
        .color-display {
            width: 100%;
            height: 100px;
            border: 2px solid #333;
            margin: 10px 0;
            text-align: center;
            line-height: 100px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            border-radius: 12px;
        }
        .formula {
            background: var(--formula-bg);
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 5px 0;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .original-colors {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .original-color {
            flex: 1;
            text-align: center;
        }
        .original-color .color-display {
            height: 80px;
            line-height: 80px;
        }
        h1, h2, h3 {
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        .highlight {
            background: var(--highlight-bg);
            padding: 15px;
            border-left: 4px solid var(--highlight-border);
            margin: 15px 0;
            border-radius: 4px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .difference {
            background: var(--difference-bg);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid var(--difference-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .color-selection {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin: 20px 0;
            transition: background-color 0.3s ease;
        }
        .color-inputs {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .color-input-group {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 15px;
            align-items: center;
        }
        .color-input-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        .color-input-group label {
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        .color-input-group input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .color-input-group input[type="text"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-row input[type="text"] {
            flex: 1;
        }
        
        .input-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .input-toggle:hover {
            background: var(--highlight-bg);
        }
        
        .input-toggle.active {
            background: var(--highlight-border);
            color: white;
        }
        
        .result-display {
            cursor: pointer;
            transition: transform 0.2s ease;
            user-select: none;
        }
        
        .result-display:hover {
            transform: scale(1.02);
        }
        
        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .copy-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .color-input-group .color-display {
            height: 60px;
            line-height: 60px;
            font-size: 14px;
            border-radius: 12px;
        }
        .ratio-control {
            text-align: center;
            margin: 20px 0;
        }
        .ratio-control label {
            font-weight: bold;
            margin-right: 10px;
        }
        .ratio-control input[type="range"] {
            width: 300px;
            margin: 0 10px;
        }
        .ratio-control span {
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .mixing-mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .mixing-mode-btn {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .mixing-mode-btn.active {
            background: var(--highlight-border);
            color: white;
            border-color: var(--highlight-border);
        }
        
        .mixing-mode-btn:hover:not(.active) {
            background: var(--highlight-bg);
        }
        
        .dosage-control {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .dosage-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dosage-input-group label {
            font-weight: bold;
            color: var(--text-color);
            white-space: nowrap;
        }
        
        .dosage-input-group input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        .dosage-result {
            font-weight: bold;
            color: var(--text-color);
            margin-left: 20px;
        }
        
        /* 响应式设计 - 手机端适配 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
            
            .comparison-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .mixing-method {
                padding: 15px;
            }
            
            .color-inputs {
                flex-direction: column;
                gap: 15px;
            }
            
            .color-input-group {
                display: grid;
                grid-template-columns: 1fr 80px;
                grid-template-rows: auto auto auto;
                gap: 8px;
                align-items: center;
            }
            
            .color-input-group label {
                grid-column: 1 / -1;
                font-size: 16px;
                margin-bottom: 5px;
            }
            
            .color-input-group input[type="color"] {
                grid-column: 2;
                grid-row: 2;
                width: 70px;
                height: 50px;
            }
            
            .color-input-group input[type="text"] {
                grid-column: 1;
                grid-row: 2;
                padding: 12px;
                font-size: 14px;
            }
            
            .color-input-group .color-display {
                grid-column: 1 / -1;
                grid-row: 3;
                height: 50px;
                line-height: 50px;
                font-size: 12px;
            }
            
            .ratio-control {
                margin: 15px 0;
            }
            
            .ratio-control label {
                display: block;
                margin-bottom: 10px;
                font-size: 16px;
            }
            
            .ratio-control input[type="range"] {
                width: 100%;
                max-width: 300px;
                height: 40px;
                margin: 10px 0;
            }
            
            .ratio-control span {
                display: block;
                font-size: 16px;
                margin-top: 10px;
            }
            
            .formula {
                font-size: 12px;
                line-height: 1.4;
                overflow-x: auto;
                white-space: normal;
                word-wrap: break-word;
                padding: 8px;
                text-align: left;
            }
            
            .formula br {
                display: block;
                margin: 4px 0;
            }
            
            .formula strong {
                display: block;
                margin: 8px 0 4px 0;
            }
            
            .color-display {
                height: 80px;
                line-height: 80px;
                font-size: 14px;
            }
            
            h1 {
                font-size: 24px;
                text-align: center;
                margin-bottom: 20px;
            }
            
            h2 {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            h3 {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            .highlight, .difference {
                padding: 12px;
                margin: 12px 0;
            }
            
            .highlight p, .difference p {
                margin: 8px 0;
                line-height: 1.4;
            }
        }
        
        /* 超小屏幕适配 */
        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            .mixing-method {
                padding: 10px;
            }
            
            .color-input-group input[type="text"] {
                font-size: 12px;
                padding: 10px;
            }
            
            .formula {
                font-size: 11px;
                padding: 6px;
                line-height: 1.3;
                text-align: left;
            }
            
            .formula strong {
                display: block;
                margin: 6px 0 3px 0;
                font-size: 12px;
            }
            
            .formula br {
                display: block;
                margin: 3px 0;
            }
            
            .color-display {
                height: 60px;
                line-height: 60px;
                font-size: 12px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            h3 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <h1>颜色混合测试记录工具</h1>

    <div class="color-selection">
        <h3>选择要混合的颜色：</h3>
        <div class="color-inputs">
            <div class="color-input-group">
                <div class="color-display" id="color1Display" style="background-color: rgb(255, 0, 0);">颜色1</div>
                <div class="color-input-controls">
                    <label>颜色1：</label>
                    <input type="color" id="color1Picker" value="#ff0000">
                    <div class="input-row">
                        <input type="text" id="color1Text" value="rgb(255, 0, 0)" placeholder="RGB或十六进制">
                        <button type="button" class="input-toggle" id="color1Toggle">HEX</button>
                    </div>
                </div>
            </div>
            <div class="color-input-group">
                <div class="color-display" id="color2Display" style="background-color: rgb(0, 0, 255);">颜色2</div>
                <div class="color-input-controls">
                    <label>颜色2：</label>
                    <input type="color" id="color2Picker" value="#0000ff">
                    <div class="input-row">
                        <input type="text" id="color2Text" value="rgb(0, 0, 255)" placeholder="RGB或十六进制">
                        <button type="button" class="input-toggle" id="color2Toggle">HEX</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 混合方式选择 -->
        <div class="mixing-mode-selector">
            <button type="button" class="mixing-mode-btn active" id="ratioModeBtn">比例混合</button>
            <button type="button" class="mixing-mode-btn" id="dosageModeBtn">剂量混合</button>
        </div>
        
        <!-- 比例控制 -->
        <div class="ratio-control" id="ratioControl">
            <label for="mixRatio">混合比例：</label>
            <input type="range" id="mixRatio" min="0" max="100" value="50">
            <span id="ratioValue">50% : 50%</span>
        </div>
        
        <!-- 剂量控制 -->
        <div class="dosage-control" id="dosageControl">
            <div class="dosage-input-group">
                <label>颜色1剂量：</label>
                <input type="number" id="dosage1" min="0" step="0.1" value="50">
                <span>ml</span>
            </div>
            <div class="dosage-input-group">
                <label>颜色2剂量：</label>
                <input type="number" id="dosage2" min="0" step="0.1" value="50">
                <span>ml</span>
            </div>
            <div class="dosage-result">
                <span id="dosageRatio">比例 50% : 50%</span><br>
                <span id="totalDosage">总量 100ml</span>
            </div>
        </div>
    </div>

    <!-- 混合结果预览区域 -->
    <div class="comparison-container">
        <div class="mixing-method">
            <h2>RGB加色混合结果</h2>
            <div id="rgbResult" class="color-display result-display">RGB混合结果</div>
            <div style="text-align: center; margin-top: 10px;">
                <div class="result-display" id="rgbDecResult" style="cursor: pointer; padding: 5px; background: var(--formula-bg); border-radius: 4px; margin: 2px; font-family: monospace;">rgb(128, 0, 128)</div>
                <div class="result-display" id="rgbHexResult" style="cursor: pointer; padding: 5px; background: var(--formula-bg); border-radius: 4px; margin: 2px; font-family: monospace;">#800080</div>
            </div>
        </div>

        <div class="mixing-method">
            <h2>CMYK减色混合结果</h2>
            <div id="cmykResult" class="color-display result-display">CMYK混合结果</div>
            <div style="text-align: center; margin-top: 10px;">
                <div class="result-display" id="cmykDecResult" style="cursor: pointer; padding: 5px; background: var(--formula-bg); border-radius: 4px; margin: 2px; font-family: monospace;">rgb(128, 64, 128)</div>
                <div class="result-display" id="cmykHexResult" style="cursor: pointer; padding: 5px; background: var(--formula-bg); border-radius: 4px; margin: 2px; font-family: monospace;">#804080</div>
            </div>
        </div>

        <div class="mixing-method">
            <h2>实际混合结果</h2>
            <div id="actualResult" class="color-display result-display" style="background-color: rgb(128, 128, 128);">实际混合结果</div>
            <div style="text-align: center; margin-top: 10px;">
                <div style="margin-bottom: 8px;">
                    <input type="text" id="actualColorText" placeholder="输入RGB或十六进制" value="rgb(128, 128, 128)" style="width: 150px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; background-color: var(--card-bg); color: var(--text-color); text-align: center;">
                </div>
                <div>
                    <input type="text" id="actualColorHex" placeholder="输入十六进制 #RRGGBB" value="#808080" style="width: 150px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; background-color: var(--card-bg); color: var(--text-color); text-align: center;">
                </div>
            </div>
        </div>
    </div>

    <!-- 存储按钮 -->
    <div class="color-selection" style="text-align: center; margin: 20px 0;">
        <button id="saveColors" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.3s ease;">
            暂存结果
        </button>
    </div>

    <!-- 存储列表 -->
    <div class="color-selection">
        <h3>已存储的测试结果：</h3>
        <div id="savedColorsList" style="min-height: 50px;">
            <p style="color: #666; text-align: center; margin: 20px 0;">暂无存储的测试结果</p>
        </div>
    </div>

    <!-- 复制成功提醒 -->
    <div id="copyNotification" class="copy-notification">
        已复制到剪贴板！
    </div>

    <script>
        // 当前颜色状态
        let currentColors = {
            color1: { r: 255, g: 0, b: 0 },
            color2: { r: 0, g: 0, b: 255 }
        };
        let currentRatio = 0.5;
        let mixingMode = 'ratio'; // 'ratio' 或 'dosage'
        
        // 输入格式状态 (true: HEX, false: RGB)
        let inputFormats = {
            color1: false, // 默认RGB格式
            color2: false  // 默认RGB格式
        };

        // 颜色转换函数
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function parseColorInput(input) {
            input = input.trim();
            
            // 十六进制格式
            if (input.startsWith('#')) {
                return hexToRgb(input);
            }
            
            // RGB格式
            const rgbMatch = input.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);
            if (rgbMatch) {
                return {
                    r: parseInt(rgbMatch[1]),
                    g: parseInt(rgbMatch[2]),
                    b: parseInt(rgbMatch[3])
                };
            }
            
            return null;
        }

        // RGB加色混合
        function mixRgbAdditive(rgb1, rgb2, ratio) {
            return {
                r: Math.round(rgb1.r * (1 - ratio) + rgb2.r * ratio),
                g: Math.round(rgb1.g * (1 - ratio) + rgb2.g * ratio),
                b: Math.round(rgb1.b * (1 - ratio) + rgb2.b * ratio)
            };
        }

        // CMYK相关函数
        function rgbToCmyk(r, g, b) {
            r = r / 255;
            g = g / 255;
            b = b / 255;

            const k = 1 - Math.max(r, Math.max(g, b));
            
            if (k >= 1) {
                return { c: 0, m: 0, y: 0, k: 100 };
            }

            const c = (1 - r - k) / (1 - k);
            const m = (1 - g - k) / (1 - k);
            const y = (1 - b - k) / (1 - k);

            return {
                c: Math.round(Math.max(0, Math.min(100, c * 100))),
                m: Math.round(Math.max(0, Math.min(100, m * 100))),
                y: Math.round(Math.max(0, Math.min(100, y * 100))),
                k: Math.round(Math.max(0, Math.min(100, k * 100)))
            };
        }

        function cmykToRgb(c, m, y, k) {
            c = Math.max(0, Math.min(100, c)) / 100;
            m = Math.max(0, Math.min(100, m)) / 100;
            y = Math.max(0, Math.min(100, y)) / 100;
            k = Math.max(0, Math.min(100, k)) / 100;

            const r = 255 * (1 - c) * (1 - k);
            const g = 255 * (1 - m) * (1 - k);
            const b = 255 * (1 - y) * (1 - k);

            return {
                r: Math.round(Math.max(0, Math.min(255, r))),
                g: Math.round(Math.max(0, Math.min(255, g))),
                b: Math.round(Math.max(0, Math.min(255, b)))
            };
        }

        function mixCmykSubtractive(cmyk1, cmyk2, ratio) {
            const density1 = {
                c: cmyk1.c / 100,
                m: cmyk1.m / 100,
                y: cmyk1.y / 100,
                k: cmyk1.k / 100
            };
            
            const density2 = {
                c: cmyk2.c / 100,
                m: cmyk2.m / 100,
                y: cmyk2.y / 100,
                k: cmyk2.k / 100
            };
            
            const effectiveDensity1 = {
                c: density1.c * (1 - ratio),
                m: density1.m * (1 - ratio),
                y: density1.y * (1 - ratio),
                k: density1.k * (1 - ratio)
            };
            
            const effectiveDensity2 = {
                c: density2.c * ratio,
                m: density2.m * ratio,
                y: density2.y * ratio,
                k: density2.k * ratio
            };
            
            const mixedDensity = {
                c: 1 - (1 - effectiveDensity1.c) * (1 - effectiveDensity2.c),
                m: 1 - (1 - effectiveDensity1.m) * (1 - effectiveDensity2.m),
                y: 1 - (1 - effectiveDensity1.y) * (1 - effectiveDensity2.y),
                k: 1 - (1 - effectiveDensity1.k) * (1 - effectiveDensity2.k)
            };
            
            return {
                c: Math.round(Math.min(100, mixedDensity.c * 100)),
                m: Math.round(Math.min(100, mixedDensity.m * 100)),
                y: Math.round(Math.min(100, mixedDensity.y * 100)),
                k: Math.round(Math.min(100, mixedDensity.k * 100))
            };
        }

        // 更新颜色显示
        function updateColorDisplay(colorNum, rgb) {
            const display = document.getElementById(`color${colorNum}Display`);
            const picker = document.getElementById(`color${colorNum}Picker`);
            const text = document.getElementById(`color${colorNum}Text`);
            const toggle = document.getElementById(`color${colorNum}Toggle`);
            
            display.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            display.textContent = `RGB(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            picker.value = rgbToHex(rgb.r, rgb.g, rgb.b);
            
            // 根据当前格式更新文本输入框
            if (inputFormats[`color${colorNum}`]) {
                text.value = rgbToHex(rgb.r, rgb.g, rgb.b);
                toggle.textContent = 'RGB';
                toggle.classList.add('active');
            } else {
                text.value = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                toggle.textContent = 'HEX';
                toggle.classList.remove('active');
            }
        }
        
        // 切换输入格式
        function toggleInputFormat(colorNum) {
            const currentFormat = inputFormats[`color${colorNum}`];
            inputFormats[`color${colorNum}`] = !currentFormat;
            
            const rgb = currentColors[`color${colorNum}`];
            updateColorDisplay(colorNum, rgb);
        }
        
        // 复制到剪贴板
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showCopyNotification();
            } catch (err) {
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyNotification();
            }
        }
        
        // 显示复制成功提醒
        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // 更新混合结果
        function updateMixingResults() {
            const ratio1 = 1 - currentRatio;
            const ratio2 = currentRatio;
            
            // 更新比例显示
            document.getElementById('ratioValue').textContent = 
                `${Math.round(ratio1 * 100)}% : ${Math.round(ratio2 * 100)}%`;
            
            // RGB加色混合
            const rgbMixed = mixRgbAdditive(currentColors.color1, currentColors.color2, currentRatio);
            
            // CMYK减色混合
            const cmyk1 = rgbToCmyk(currentColors.color1.r, currentColors.color1.g, currentColors.color1.b);
            const cmyk2 = rgbToCmyk(currentColors.color2.r, currentColors.color2.g, currentColors.color2.b);
            const cmykMixed = mixCmykSubtractive(cmyk1, cmyk2, currentRatio);
            const cmykToRgbResult = cmykToRgb(cmykMixed.c, cmykMixed.m, cmykMixed.y, cmykMixed.k);
            
            // 更新显示
            const rgbResult = document.getElementById('rgbResult');
            rgbResult.style.backgroundColor = `rgb(${rgbMixed.r}, ${rgbMixed.g}, ${rgbMixed.b})`;
            rgbResult.textContent = `RGB(${rgbMixed.r}, ${rgbMixed.g}, ${rgbMixed.b})`;

            const cmykResult = document.getElementById('cmykResult');
            cmykResult.style.backgroundColor = `rgb(${cmykToRgbResult.r}, ${cmykToRgbResult.g}, ${cmykToRgbResult.b})`;
            cmykResult.textContent = `RGB(${cmykToRgbResult.r}, ${cmykToRgbResult.g}, ${cmykToRgbResult.b})`;
            
            // 更新结果显示的十进制和十六进制格式
            document.getElementById('rgbDecResult').textContent = `rgb(${rgbMixed.r}, ${rgbMixed.g}, ${rgbMixed.b})`;
            document.getElementById('rgbHexResult').textContent = rgbToHex(rgbMixed.r, rgbMixed.g, rgbMixed.b);
            document.getElementById('cmykDecResult').textContent = `rgb(${cmykToRgbResult.r}, ${cmykToRgbResult.g}, ${cmykToRgbResult.b})`;
            document.getElementById('cmykHexResult').textContent = rgbToHex(cmykToRgbResult.r, cmykToRgbResult.g, cmykToRgbResult.b);

            // 更新差异分析
            const differenceAnalysis = document.getElementById('differenceAnalysis');
            const rDiff = Math.abs(rgbMixed.r - cmykToRgbResult.r);
            const gDiff = Math.abs(rgbMixed.g - cmykToRgbResult.g);
            const bDiff = Math.abs(rgbMixed.b - cmykToRgbResult.b);
            
            differenceAnalysis.innerHTML = `
                <p><strong>RGB加色混合：</strong> RGB(${rgbMixed.r}, ${rgbMixed.g}, ${rgbMixed.b})</p>
                <p><strong>CMYK减色混合：</strong> RGB(${cmykToRgbResult.r}, ${cmykToRgbResult.g}, ${cmykToRgbResult.b})</p>
                <p><strong>数值差异：</strong> R差${rDiff}, G差${gDiff}, B差${bDiff}</p>
                <p><strong>视觉差异：</strong> ${gDiff > 10 ? 'CMYK混合结果明显更暗' : '两种混合结果较为接近'}</p>
                <p><strong>CMYK值：</strong> C:${cmykMixed.c}% M:${cmykMixed.m}% Y:${cmykMixed.y}% K:${cmykMixed.k}%</p>
            `;
            
            // 动态更新混合公式
            updateFormulas(rgbMixed, cmyk1, cmyk2, cmykMixed, cmykToRgbResult, ratio1, ratio2);
        }
        
        // 动态更新公式显示
        function updateFormulas(rgbMixed, cmyk1, cmyk2, cmykMixed, cmykToRgbResult, ratio1, ratio2) {
            // 更新RGB加色混合公式
            const rgbFormulaDiv = document.querySelector('.mixing-method:nth-child(1) .formula');
            rgbFormulaDiv.innerHTML = `
                <strong>加色混合公式：</strong><br>
                mixed = color1 × ratio1 + color2 × ratio2<br><br>
                
                <strong>当前比例：${Math.round(ratio1 * 100)}% : ${Math.round(ratio2 * 100)}%</strong><br><br>
                
                <strong>计算过程：</strong><br>
                R = ${currentColors.color1.r} × ${ratio1.toFixed(2)} + ${currentColors.color2.r} × ${ratio2.toFixed(2)} = ${(currentColors.color1.r * ratio1 + currentColors.color2.r * ratio2).toFixed(1)} ≈ ${rgbMixed.r}<br>
                G = ${currentColors.color1.g} × ${ratio1.toFixed(2)} + ${currentColors.color2.g} × ${ratio2.toFixed(2)} = ${(currentColors.color1.g * ratio1 + currentColors.color2.g * ratio2).toFixed(1)} ≈ ${rgbMixed.g}<br>
                B = ${currentColors.color1.b} × ${ratio1.toFixed(2)} + ${currentColors.color2.b} × ${ratio2.toFixed(2)} = ${(currentColors.color1.b * ratio1 + currentColors.color2.b * ratio2).toFixed(1)} ≈ ${rgbMixed.b}<br><br>
                
                <strong>结果：RGB(${rgbMixed.r}, ${rgbMixed.g}, ${rgbMixed.b})</strong>
            `;
            
            // 更新CMYK减色混合公式
            const cmykFormulaDiv = document.querySelector('.mixing-method:nth-child(2) .formula');
            cmykFormulaDiv.innerHTML = `
                <strong>步骤1：RGB转CMYK</strong><br>
                颜色1 RGB(${currentColors.color1.r}, ${currentColors.color1.g}, ${currentColors.color1.b}) → CMYK(${cmyk1.c}%, ${cmyk1.m}%, ${cmyk1.y}%, ${cmyk1.k}%)<br>
                颜色2 RGB(${currentColors.color2.r}, ${currentColors.color2.g}, ${currentColors.color2.b}) → CMYK(${cmyk2.c}%, ${cmyk2.m}%, ${cmyk2.y}%, ${cmyk2.k}%)<br><br>
                
                <strong>步骤2：CMYK减色混合（${Math.round(ratio1 * 100)}%:${Math.round(ratio2 * 100)}%比例）</strong><br>
                减色混合公式：mixed = 1 - (1 - d1×ratio1) × (1 - d2×ratio2)<br><br>
                
                C通道混合：<br>
                • 颜色1密度：${cmyk1.c}% × ${Math.round(ratio1 * 100)}% = ${Math.round(cmyk1.c * ratio1)}%<br>
                • 颜色2密度：${cmyk2.c}% × ${Math.round(ratio2 * 100)}% = ${Math.round(cmyk2.c * ratio2)}%<br>
                • 混合结果：1 - (1-${(cmyk1.c * ratio1 / 100).toFixed(2)}) × (1-${(cmyk2.c * ratio2 / 100).toFixed(2)}) = ${cmykMixed.c}%<br><br>
                
                M通道混合：<br>
                • 颜色1密度：${cmyk1.m}% × ${Math.round(ratio1 * 100)}% = ${Math.round(cmyk1.m * ratio1)}%<br>
                • 颜色2密度：${cmyk2.m}% × ${Math.round(ratio2 * 100)}% = ${Math.round(cmyk2.m * ratio2)}%<br>
                • 混合结果：1 - (1-${(cmyk1.m * ratio1 / 100).toFixed(2)}) × (1-${(cmyk2.m * ratio2 / 100).toFixed(2)}) = ${cmykMixed.m}%<br><br>
                
                Y通道混合：<br>
                • 颜色1密度：${cmyk1.y}% × ${Math.round(ratio1 * 100)}% = ${Math.round(cmyk1.y * ratio1)}%<br>
                • 颜色2密度：${cmyk2.y}% × ${Math.round(ratio2 * 100)}% = ${Math.round(cmyk2.y * ratio2)}%<br>
                • 混合结果：1 - (1-${(cmyk1.y * ratio1 / 100).toFixed(2)}) × (1-${(cmyk2.y * ratio2 / 100).toFixed(2)}) = ${cmykMixed.y}%<br><br>
                
                K通道混合：<br>
                • 颜色1密度：${cmyk1.k}% × ${Math.round(ratio1 * 100)}% = ${Math.round(cmyk1.k * ratio1)}%<br>
                • 颜色2密度：${cmyk2.k}% × ${Math.round(ratio2 * 100)}% = ${Math.round(cmyk2.k * ratio2)}%<br>
                • 混合结果：1 - (1-${(cmyk1.k * ratio1 / 100).toFixed(2)}) × (1-${(cmyk2.k * ratio2 / 100).toFixed(2)}) = ${cmykMixed.k}%<br><br>
                
                <strong>混合结果CMYK：C=${cmykMixed.c}%, M=${cmykMixed.m}%, Y=${cmykMixed.y}%, K=${cmykMixed.k}%</strong><br><br>
                
                <strong>步骤3：CMYK转回RGB</strong><br>
                转换公式：RGB = 255 × (1-C) × (1-K) （每个通道独立计算）<br><br>
                
                R = 255 × (1-${(cmykMixed.c/100).toFixed(2)}) × (1-${(cmykMixed.k/100).toFixed(2)}) = 255 × ${(1-cmykMixed.c/100).toFixed(2)} × ${(1-cmykMixed.k/100).toFixed(2)} = ${(255 * (1-cmykMixed.c/100) * (1-cmykMixed.k/100)).toFixed(1)} ≈ ${cmykToRgbResult.r}<br>
                G = 255 × (1-${(cmykMixed.m/100).toFixed(2)}) × (1-${(cmykMixed.k/100).toFixed(2)}) = 255 × ${(1-cmykMixed.m/100).toFixed(2)} × ${(1-cmykMixed.k/100).toFixed(2)} = ${(255 * (1-cmykMixed.m/100) * (1-cmykMixed.k/100)).toFixed(1)} ≈ ${cmykToRgbResult.g}<br>
                B = 255 × (1-${(cmykMixed.y/100).toFixed(2)}) × (1-${(cmykMixed.k/100).toFixed(2)}) = 255 × ${(1-cmykMixed.y/100).toFixed(2)} × ${(1-cmykMixed.k/100).toFixed(2)} = ${(255 * (1-cmykMixed.y/100) * (1-cmykMixed.k/100)).toFixed(1)} ≈ ${cmykToRgbResult.b}<br><br>
                
                <strong>最终结果：RGB(${cmykToRgbResult.r}, ${cmykToRgbResult.g}, ${cmykToRgbResult.b})</strong>
            `;
        }

        // 更新实际混合结果显示
        function updateActualResult() {
            const actualColorText = document.getElementById('actualColorText');
            const actualResult = document.getElementById('actualResult');
            
            const rgb = parseColorInput(actualColorText.value);
            if (rgb) {
                actualResult.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                actualResult.textContent = `RGB(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }
        }

        // 从比例更新剂量
        function updateDosageFromRatio() {
            if (mixingMode === 'dosage') {
                const ratio1 = 1 - currentRatio;
                const ratio2 = currentRatio;
                
                // 保持总量为100ml，按比例分配
                const dosage1 = (ratio1 * 100).toFixed(1);
                const dosage2 = (ratio2 * 100).toFixed(1);
                
                document.getElementById('dosage1').value = dosage1;
                document.getElementById('dosage2').value = dosage2;
                
                updateDosageDisplay();
            }
        }

        // 从剂量更新比例
        function updateRatioFromDosage() {
            const dosage1 = parseFloat(document.getElementById('dosage1').value) || 0;
            const dosage2 = parseFloat(document.getElementById('dosage2').value) || 0;
            const total = dosage1 + dosage2;
            
            if (total > 0) {
                const ratio1 = dosage1 / total;
                const ratio2 = dosage2 / total;
                
                currentRatio = ratio2; // currentRatio是颜色2的比例
                
                // 更新滑杆位置（但不显示）
                document.getElementById('mixRatio').value = Math.round(currentRatio * 100);
                
                updateDosageDisplay();
                updateMixingResults();
            }
        }

        // 更新剂量显示
        function updateDosageDisplay() {
            const dosage1 = parseFloat(document.getElementById('dosage1').value) || 0;
            const dosage2 = parseFloat(document.getElementById('dosage2').value) || 0;
            const total = dosage1 + dosage2;
            
            if (total > 0) {
                const ratio1Percent = Math.round((dosage1 / total) * 100);
                const ratio2Percent = Math.round((dosage2 / total) * 100);
                
                document.getElementById('dosageRatio').textContent = `比例 ${ratio1Percent}% : ${ratio2Percent}%`;
                document.getElementById('totalDosage').textContent = `总量 ${total.toFixed(1)}ml`;
            } else {
                document.getElementById('dosageRatio').textContent = '比例 0% : 0%';
                document.getElementById('totalDosage').textContent = '总量 0ml';
            }
        }

        // 存储功能 - 全局变量
        let savedColors = [];
        
        // 初始化存储的颜色数据
        function initializeSavedColors() {
            try {
                const savedColorsStr = localStorage.getItem('savedColors');
                if (savedColorsStr) {
                    savedColors = JSON.parse(savedColorsStr);
                    console.log('从localStorage加载了', savedColors.length, '条颜色记录');
                } else {
                    savedColors = [];
                    console.log('localStorage中没有保存的颜色记录');
                }
            } catch (error) {
                console.error('读取localStorage数据时出错:', error);
                savedColors = [];
                // 清除损坏的数据
                localStorage.removeItem('savedColors');
            }
            
            // 立即更新显示
            updateSavedColorsList();
        }
        
        // 更新存储列表显示
        function updateSavedColorsList() {
            const listContainer = document.getElementById('savedColorsList');
            
            if (savedColors.length === 0) {
                listContainer.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">暂无存储的颜色组合</p>';
                return;
            }
            
            let html = '';
            savedColors.forEach((item, index) => {
                html += `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin: 10px 0; background: var(--card-bg); transition: all 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 14px; color: #666;">${item.timestamp}</span>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadColorCombination(${item.id})" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">载入此组合</button>
                                <button onclick="copyColorData(${item.id})" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">复制此数据</button>
                                <button onclick="deleteSavedColor(${item.id})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">删除</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; align-items: stretch;">
                            <div style="text-align: center;">
                                <div style="width: 100%; height: 50px; background: rgb(${item.color1.r}, ${item.color1.g}, ${item.color1.b}); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 11px;">${rgbToHex(item.color1.r, item.color1.g, item.color1.b)}</div>
                                <div style="font-size: 11px; font-family: monospace; color: #666;">颜色1</div>
                                <div style="font-size: 10px; font-family: monospace; color: #888;">RGB(${item.color1.r}, ${item.color1.g}, ${item.color1.b})</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 100%; height: 50px; background: rgb(${item.color2.r}, ${item.color2.g}, ${item.color2.b}); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 11px;">${rgbToHex(item.color2.r, item.color2.g, item.color2.b)}</div>
                                <div style="font-size: 11px; font-family: monospace; color: #666;">颜色2</div>
                                <div style="font-size: 10px; font-family: monospace; color: #888;">RGB(${item.color2.r}, ${item.color2.g}, ${item.color2.b})</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 100%; height: 50px; background: rgb(${item.rgbResult.r}, ${item.rgbResult.g}, ${item.rgbResult.b}); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 11px;">${rgbToHex(item.rgbResult.r, item.rgbResult.g, item.rgbResult.b)}</div>
                                <div style="font-size: 11px; font-family: monospace; color: #666;">RGB混合</div>
                                <div style="font-size: 10px; color: #888;">${item.ratio}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 100%; height: 50px; background: rgb(${item.cmykResult.r}, ${item.cmykResult.g}, ${item.cmykResult.b}); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 11px;">${rgbToHex(item.cmykResult.r, item.cmykResult.g, item.cmykResult.b)}</div>
                                <div style="font-size: 11px; font-family: monospace; color: #666;">CMYK混合</div>
                                <div style="font-size: 10px; color: #888;">${item.ratio}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 100%; height: 50px; background: rgb(${item.actualResult.r}, ${item.actualResult.g}, ${item.actualResult.b}); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 11px;">${rgbToHex(item.actualResult.r, item.actualResult.g, item.actualResult.b)}</div>
                                <div style="font-size: 11px; font-family: monospace; color: #666;">实际结果</div>
                                <div style="font-size: 10px; font-family: monospace; color: #888;">RGB(${item.actualResult.r}, ${item.actualResult.g}, ${item.actualResult.b})</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        // 删除存储的颜色
        function deleteSavedColor(id) {
            savedColors = savedColors.filter(item => item.id !== id);
            localStorage.setItem('savedColors', JSON.stringify(savedColors));
            updateSavedColorsList();
        }
        
        // 载入颜色组合
        function loadColorCombination(id) {
            const item = savedColors.find(item => item.id === id);
            if (item) {
                currentColors.color1 = { ...item.color1 };
                currentColors.color2 = { ...item.color2 };
                
                // 从比例字符串解析比例值
                const ratioMatch = item.ratio.match(/(\d+)%:(\d+)%/);
                if (ratioMatch) {
                    const ratio1 = parseInt(ratioMatch[1]);
                    currentRatio = 1 - (ratio1 / 100);
                    document.getElementById('mixRatio').value = Math.round(currentRatio * 100);
                }
                
                updateColorDisplay(1, currentColors.color1);
                updateColorDisplay(2, currentColors.color2);
                updateMixingResults();
                
                // 滚动到顶部
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // 复制颜色数据
        function copyColorData(id) {
            const item = savedColors.find(item => item.id === id);
            if (item) {
                const data = `颜色组合 (${item.timestamp})
颜色1: RGB(${item.color1.r}, ${item.color1.g}, ${item.color1.b}) / ${rgbToHex(item.color1.r, item.color1.g, item.color1.b)}
颜色2: RGB(${item.color2.r}, ${item.color2.g}, ${item.color2.b}) / ${rgbToHex(item.color2.r, item.color2.g, item.color2.b)}
混合比例: ${item.ratio}
RGB混合结果: RGB(${item.rgbResult.r}, ${item.rgbResult.g}, ${item.rgbResult.b}) / ${rgbToHex(item.rgbResult.r, item.rgbResult.g, item.rgbResult.b)}
CMYK混合结果: RGB(${item.cmykResult.r}, ${item.cmykResult.g}, ${item.cmykResult.b}) / ${rgbToHex(item.cmykResult.r, item.cmykResult.g, item.cmykResult.b)}`;
                copyToClipboard(data);
            }
        }

        // 事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 颜色选择器事件
            document.getElementById('color1Picker').addEventListener('input', function(e) {
                const rgb = hexToRgb(e.target.value);
                if (rgb) {
                    currentColors.color1 = rgb;
                    updateColorDisplay(1, rgb);
                    updateMixingResults();
                }
            });

            document.getElementById('color2Picker').addEventListener('input', function(e) {
                const rgb = hexToRgb(e.target.value);
                if (rgb) {
                    currentColors.color2 = rgb;
                    updateColorDisplay(2, rgb);
                    updateMixingResults();
                }
            });

            // 实际混合结果输入事件
            document.getElementById('actualColorText').addEventListener('input', function(e) {
                updateActualResult();
                // 同步更新十六进制输入框
                const rgb = parseColorInput(e.target.value);
                if (rgb) {
                    document.getElementById('actualColorHex').value = rgbToHex(rgb.r, rgb.g, rgb.b);
                }
            });

            document.getElementById('actualColorHex').addEventListener('input', function(e) {
                const rgb = parseColorInput(e.target.value);
                if (rgb) {
                    document.getElementById('actualColorText').value = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                    updateActualResult();
                }
            });

            // 文本输入事件
            document.getElementById('color1Text').addEventListener('input', function(e) {
                const rgb = parseColorInput(e.target.value);
                if (rgb) {
                    currentColors.color1 = rgb;
                    updateColorDisplay(1, rgb);
                    updateMixingResults();
                }
            });

            document.getElementById('color2Text').addEventListener('input', function(e) {
                const rgb = parseColorInput(e.target.value);
                if (rgb) {
                    currentColors.color2 = rgb;
                    updateColorDisplay(2, rgb);
                    updateMixingResults();
                }
            });

            // 比例滑杆事件
            document.getElementById('mixRatio').addEventListener('input', function(e) {
                currentRatio = e.target.value / 100;
                updateMixingResults();
                updateDosageFromRatio();
            });

            // 混合方式切换事件
            document.getElementById('ratioModeBtn').addEventListener('click', function() {
                mixingMode = 'ratio';
                document.getElementById('ratioModeBtn').classList.add('active');
                document.getElementById('dosageModeBtn').classList.remove('active');
                document.getElementById('ratioControl').style.display = 'block';
                document.getElementById('dosageControl').style.display = 'none';
            });

            document.getElementById('dosageModeBtn').addEventListener('click', function() {
                mixingMode = 'dosage';
                document.getElementById('dosageModeBtn').classList.add('active');
                document.getElementById('ratioModeBtn').classList.remove('active');
                document.getElementById('ratioControl').style.display = 'none';
                document.getElementById('dosageControl').style.display = 'flex';
                updateDosageFromRatio();
            });

            // 剂量输入事件
            document.getElementById('dosage1').addEventListener('input', function() {
                updateRatioFromDosage();
            });

            document.getElementById('dosage2').addEventListener('input', function() {
                updateRatioFromDosage();
            });

            // 切换按钮事件
            document.getElementById('color1Toggle').addEventListener('click', function() {
                toggleInputFormat(1);
            });

            document.getElementById('color2Toggle').addEventListener('click', function() {
                toggleInputFormat(2);
            });

            // 结果复制事件
            document.getElementById('rgbDecResult').addEventListener('click', function() {
                copyToClipboard(this.textContent);
            });

            document.getElementById('rgbHexResult').addEventListener('click', function() {
                copyToClipboard(this.textContent);
            });

            document.getElementById('cmykDecResult').addEventListener('click', function() {
                copyToClipboard(this.textContent);
            });

            document.getElementById('cmykHexResult').addEventListener('click', function() {
                copyToClipboard(this.textContent);
            });
            
            // 存储按钮事件
            document.getElementById('saveColors').addEventListener('click', function() {
                try {
                    console.log('开始保存颜色组合...');
                    
                    // 检查localStorage是否可用
                    if (typeof(Storage) === "undefined") {
                        throw new Error('浏览器不支持localStorage');
                    }
                    
                    const ratio1 = Math.round((1 - currentRatio) * 100);
                    const ratio2 = Math.round(currentRatio * 100);
                    
                    console.log('当前比例:', ratio1, ratio2);
                    console.log('当前颜色:', currentColors);
                    console.log('混合模式:', mixingMode);
                    
                    // 根据混合模式获取比例信息
                    let ratioInfo = `${ratio1}%:${ratio2}%`;
                    let dosageInfo = null;
                    
                    if (mixingMode === 'dosage') {
                        const dosage1 = parseFloat(document.getElementById('dosage1').value) || 0;
                        const dosage2 = parseFloat(document.getElementById('dosage2').value) || 0;
                        const total = dosage1 + dosage2;
                        
                        dosageInfo = {
                            dosage1: dosage1,
                            dosage2: dosage2,
                            total: total,
                            unit: 'ml'
                        };
                        
                        ratioInfo = `${ratio1}%:${ratio2}% (${dosage1}ml:${dosage2}ml)`;
                    }
                    
                    // 简化的RGB混合计算（直接在这里计算，避免函数调用问题）
                    const rgbMixed = {
                        r: Math.round(currentColors.color1.r * (1 - currentRatio) + currentColors.color2.r * currentRatio),
                        g: Math.round(currentColors.color1.g * (1 - currentRatio) + currentColors.color2.g * currentRatio),
                        b: Math.round(currentColors.color1.b * (1 - currentRatio) + currentColors.color2.b * currentRatio)
                    };
                    
                    console.log('RGB混合结果:', rgbMixed);
                    
                    // 获取当前显示的CMYK混合结果（从DOM中读取）
                    const cmykResultElement = document.getElementById('cmykResult');
                    const cmykResultText = cmykResultElement.textContent;
                    const cmykResultMatch = cmykResultText.match(/RGB\((\d+), (\d+), (\d+)\)/);
                    const cmykToRgbResult = cmykResultMatch ? {
                        r: parseInt(cmykResultMatch[1]),
                        g: parseInt(cmykResultMatch[2]),
                        b: parseInt(cmykResultMatch[3])
                    } : { r: 128, g: 128, b: 128 };
                    
                    console.log('CMYK混合结果:', cmykToRgbResult);
                    
                    // 获取实际混合结果
                    const actualColorText = document.getElementById('actualColorText').value;
                    let actualResult = { r: 128, g: 128, b: 128 };
                    
                    // 简化的颜色解析
                    if (actualColorText.includes('rgb')) {
                        const match = actualColorText.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);
                        if (match) {
                            actualResult = {
                                r: parseInt(match[1]),
                                g: parseInt(match[2]),
                                b: parseInt(match[3])
                            };
                        }
                    } else if (actualColorText.startsWith('#')) {
                        const hex = actualColorText.replace('#', '');
                        if (hex.length === 6) {
                            actualResult = {
                                r: parseInt(hex.substr(0, 2), 16),
                                g: parseInt(hex.substr(2, 2), 16),
                                b: parseInt(hex.substr(4, 2), 16)
                            };
                        }
                    }
                    
                    console.log('实际混合结果:', actualResult);
                    
                    const colorData = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleString('zh-CN'),
                        color1: { ...currentColors.color1 },
                        color2: { ...currentColors.color2 },
                        ratio: ratioInfo,
                        mixingMode: mixingMode,
                        dosageInfo: dosageInfo,
                        rgbResult: rgbMixed,
                        cmykResult: cmykToRgbResult,
                        actualResult: actualResult
                    };
                    
                    console.log('准备保存的数据:', colorData);
                    
                    // 尝试保存到localStorage
                    const savedColorsStr = localStorage.getItem('savedColors');
                    let savedColorsList = [];
                    
                    if (savedColorsStr) {
                        try {
                            savedColorsList = JSON.parse(savedColorsStr);
                        } catch (e) {
                            console.warn('解析已保存的颜色数据失败，将重新开始:', e);
                            savedColorsList = [];
                        }
                    }
                    
                    savedColorsList.unshift(colorData); // 添加到开头
                    if (savedColorsList.length > 20) { // 最多保存20条记录
                        savedColorsList = savedColorsList.slice(0, 20);
                    }
                    
                    const dataStr = JSON.stringify(savedColorsList);
                    localStorage.setItem('savedColors', dataStr);
                    
                    // 更新全局变量
                    savedColors = savedColorsList;
                    
                    console.log('保存成功，更新显示列表');
                    updateSavedColorsList();
                    
                    // 显示保存成功提示
                    const button = document.getElementById('saveColors');
                    const originalText = button.textContent;
                    button.textContent = '已保存！';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#007bff';
                    }, 1500);
                    
                    console.log('保存完成');
                } catch (error) {
                    console.error('保存颜色时出错:', error);
                    alert('保存失败：' + error.message);
                }
            });
            
            // 将函数绑定到window对象以供HTML onclick使用
            window.deleteSavedColor = deleteSavedColor;
            window.loadColorCombination = loadColorCombination;
            window.copyColorData = copyColorData;

            // 初始化存储的颜色数据并显示（必须在其他初始化之前）
            initializeSavedColors();
            
            // 初始化显示
            updateColorDisplay(1, currentColors.color1);
            updateColorDisplay(2, currentColors.color2);
            updateMixingResults();
        });
    </script>
</body>
</html>
